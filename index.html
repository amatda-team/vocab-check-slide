<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Check - 오늘의 단어</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --line:rgba(0,0,0,.08);
      --muted:rgba(0,0,0,.5); --shadow:0 14px 40px rgba(0,0,0,.08);
      --r:18px; --max:720px;
      --green:#3ec67a; --red:#f45a5a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;color:#111}
    .wrap{max-width:var(--max);margin:0 auto;padding:22px 16px 40px}
    h1{margin:0 0 6px;font-size:26px;letter-spacing:-.02em}
    .sub{margin:0 0 16px;color:var(--muted);line-height:1.5}

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; padding:12px 0;
      background:linear-gradient(to bottom, rgba(246,247,249,.98), rgba(246,247,249,.75), rgba(246,247,249,0));
      backdrop-filter: blur(6px);
      z-index:10;
    }
    .pill{
      background:var(--card); border:1px solid var(--line); border-radius:999px;
      padding:10px 12px; display:flex; gap:10px; align-items:center;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      min-height:44px;
    }
    .pill b{font-size:14px}
    .pill span{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--line); background:var(--card);
      border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    .panel{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--r); box-shadow:var(--shadow);
      padding:16px; margin-top:14px;
    }
    .panelHead{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .panelHead h2{margin:0;font-size:18px;letter-spacing:-.02em}
    .mini{font-size:12px;color:var(--muted)}

    .rows{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .row{
      background:rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px;
    }
    .track{
      position:relative;
      height:44px;
      border-radius:999px;
      background:rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.06);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .zone{
      position:absolute;top:0;bottom:0;width:32%;
      display:flex;align-items:center;padding:0 14px;
      font-weight:800;font-size:12px;color:rgba(0,0,0,.38);
      user-select:none; cursor:pointer;
    }
    .zone.left{left:0;justify-content:flex-start}
    .zone.right{right:0;justify-content:flex-end}

    .center{
      position:relative; z-index:1;
      max-width:62%;
      padding:0 56px;
      font-weight:900;
      letter-spacing:-.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
      transition:.15s;
    }
    .center.meaning{color:rgba(0,0,0,.78);font-weight:800}

    .thumb{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      height:34px; padding:0 16px; border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-weight:950; letter-spacing:-.02em;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 14px 28px rgba(0,0,0,.12);
      background:rgba(0,0,0,.10);
      color:rgba(0,0,0,.86);
      cursor:grab; user-select:none;
      transition:left .16s ease, background .16s ease, color .16s ease, transform .16s ease;
      z-index:2;
      will-change:left;
    }
    .thumb:active{cursor:grabbing}

    .meta{margin-top:8px;display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .meta .state{font-weight:900;color:rgba(0,0,0,.62)}

    .footer{display:flex;justify-content:flex-end;margin-top:14px}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5}

    /* Toast */
    .toasts{position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:10px}
    .toast{
      width:min(520px, calc(100vw - 28px));
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 18px 40px rgba(0,0,0,.14);
      font-weight:800;
    }
    .toast small{display:block;margin-top:2px;color:var(--muted);font-weight:700}

    /* Modal / Overlay */
    .backdrop{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(255,255,255,.60);backdrop-filter:blur(8px);
      z-index:9990;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(520px, calc(100vw - 28px));
      background:rgba(255,255,255,.94);
      border:1px solid rgba(0,0,0,.10);
      border-radius:18px;
      box-shadow:0 22px 60px rgba(0,0,0,.20);
      padding:16px;
    }
    .modal h3{margin:0 0 6px;font-size:16px;letter-spacing:-.02em}
    .modal p{margin:0;color:var(--muted);line-height:1.5;font-size:13px}
    .modal .tip{margin:10px 0 10px;font-weight:950}
    .modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}

    .overlayCard{
      text-align:center;
      padding:18px 16px;
    }
    .spinner{
      width:28px;height:28px;border-radius:50%;
      border:3px solid rgba(0,0,0,.12);
      border-top-color: rgba(0,0,0,.65);
      margin:12px auto 0;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:520px){
      .wrap{padding:18px 12px 34px}
      .center{padding:0 50px}
    }
  </style>
</head>
<body>
  <div class="toasts" id="toasts"></div>

  <div class="wrap">
    <h1>오늘의 단어</h1>
    <p class="sub">단어 필을 좌/우로 밀어서 선택해줘. 고정되면 뜻이 보여. 처음엔 비어있으니 충전하기로 시작!</p>

    <div class="top">
      <div class="pill">
        <b id="todayCount">0개</b>
        <span id="chargeLeft">오늘 남은 충전 3/3</span>
      </div>
      <button class="btn" id="btnCharge">충전하기</button>
    </div>

    <div class="panel">
      <div class="panelHead">
        <h2>단어 목록</h2>
        <div class="mini" id="selectionHint">아직 단어가 없어. 충전하기로 시작!</div>
      </div>

      <div class="rows" id="rows"></div>

      <div class="footer">
        <button class="btn primary" id="btnSubmit">제출하기</button>
      </div>

      <div class="hint">
        * 제출은 “한 번에” 처리돼. 중간에 실수해도 다시 드래그해서 바꾸면 돼.
      </div>
    </div>
  </div>

  <!-- Charge Modal -->
  <div class="backdrop" id="chargeBD">
    <div class="modal">
      <h3>충전하기</h3>
      <div class="tip" id="chargeTip"></div>
      <p id="chargeSub"></p>
      <div class="actions">
        <button class="btn" id="chargeClose">닫기</button>
        <button class="btn primary" id="chargeDo">충전하기</button>
      </div>
      <p style="margin-top:10px;font-size:12px;color:var(--muted)" id="chargeRemain"></p>
    </div>
  </div>

  <!-- Submit Modal -->
  <div class="backdrop" id="submitBD">
    <div class="modal">
      <h3>제출하시겠습니까?</h3>
      <div class="tip" id="submitTip"></div>
      <p>오늘 선택한 내용을 저장하고, 결과 화면으로 이동해.</p>
      <div class="actions">
        <button class="btn" id="submitClose">닫기</button>
        <button class="btn primary" id="submitDo">제출하기</button>
      </div>
    </div>
  </div>

  <!-- Updating Overlay -->
  <div class="backdrop" id="overlayBD">
    <div class="modal overlayCard">
      <h3 style="margin:0;font-size:16px;letter-spacing:-.02em;">통계 업데이트 중…</h3>
      <p style="margin-top:6px;">잠깐만! 거의 다 됐어.</p>
      <div class="spinner"></div>
    </div>
  </div>

<script>
(() => {
  const LS_KEY = "vc_proto_v2";
  const todayTargetAdd = 10;
  const dailyChargeLimit = 3;

  const WORD_POOL = [
    ["analyze","분석하다"],["assume","가정하다"],["evidence","증거"],["infer","추론하다"],["interpret","해석하다"],
    ["justify","정당화하다"],["conclude","결론내리다"],["contrast","대조하다"],["maintain","유지하다"],["derive","도출하다"],
    ["concept","개념"],["abstract","추상적인"],["concrete","구체적인"],["consistent","일관된"],["significant","중요한"],
    ["approximate","대략적인"],["precise","정확한"],["expand","확장하다"],["reduce","줄이다"],["enhance","향상시키다"],
    ["persist","지속되다"],["resolve","해결하다"],["strategy","전략"],["variable","변수"],["reliable","신뢰할 만한"],
    ["occur","발생하다"],["imply","암시하다"],["indicate","나타내다"],["reflect","반영하다"],["affect","영향을 미치다"],
    ["benefit","이익"],["challenge","도전/문제"],["approach","접근"],["context","문맥"],["factor","요인"]
  ];

  const TIPS = [
    "뜻을 보고 “아는 느낌”이 들면, 오른쪽 고정 전에 1초만 더 확인해봐.",
    "몰라요는 실패가 아니라 ‘성장 포인트’야.",
    "오늘은 속도보다 정확. 고정 후 뜻을 한 번 읽는 것만으로도 효과가 커.",
    "알아요로 보냈다면 예문이 떠오르는지 1초만 체크!",
    "충전은 시작 버튼이야. 10개만 처리해도 오늘은 성공."
  ];

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };

  const loadState = () => {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      return {
        meta: { date: todayKey(), chargeUsed: 0, usedTipIdx: [] },
        today: [],
        wordStats: {},
        processedSubmitCount: 0
      };
    }
    try{
      const st = JSON.parse(raw);
      const tk = todayKey();
      if (!st.meta || st.meta.date !== tk){
        st.meta = { date: tk, chargeUsed: 0, usedTipIdx: [] };
      }
      st.today = Array.isArray(st.today) ? st.today : [];
      st.wordStats = st.wordStats || {};
      st.processedSubmitCount = Number(st.processedSubmitCount || 0);
      return st;
    }catch(e){
      localStorage.removeItem(LS_KEY);
      return loadState();
    }
  };
  const saveState = (st) => localStorage.setItem(LS_KEY, JSON.stringify(st));

  const toast = (title, sub="") => {
    const host = $("toasts");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `${escapeHtml(title)}${sub?`<small>${escapeHtml(sub)}</small>`:""}`;
    host.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(-4px)"; }, 1600);
    setTimeout(()=> el.remove(), 2200);
  };

  const escapeHtml = (s) => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const pickTipNoRepeatToday = (st) => {
    const used = new Set(st.meta.usedTipIdx || []);
    const candidates = [];
    for (let i=0;i<TIPS.length;i++) if (!used.has(i)) candidates.push(i);
    let idx;
    if (candidates.length === 0) { st.meta.usedTipIdx = []; idx = Math.floor(Math.random()*TIPS.length); }
    else idx = candidates[Math.floor(Math.random()*candidates.length)];
    st.meta.usedTipIdx = st.meta.usedTipIdx || [];
    st.meta.usedTipIdx.push(idx);
    saveState(st);
    return TIPS[idx];
  };

  const addTodayWords = (st, n) => {
    const existing = new Set(st.today.map(x => x.w));
    const candidates = WORD_POOL.filter(([w]) => !existing.has(w));
    const add = Math.min(n, candidates.length);
    for (let i=0;i<add;i++){
      const [w,m] = candidates.splice(Math.floor(Math.random()*candidates.length), 1)[0];
      st.today.push({ w, m, state: "neutral", x: 0 });
    }
    saveState(st);
    return add;
  };

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp = (a,b,t)=>a+(b-a)*t;

  const stateLabel = (st)=> st==="know"?"알아요":st==="dont"?"몰라요":"미선택";

  let state = loadState();

  const updateTop = () => {
    $("todayCount").textContent = `${state.today.length}개`;
    const left = Math.max(0, dailyChargeLimit - (state.meta.chargeUsed||0));
    $("chargeLeft").textContent = `오늘 남은 충전 ${left}/${dailyChargeLimit}`;
    const chosen = state.today.filter(x=>x.state!=="neutral").length;
    $("selectionHint").textContent = state.today.length===0 ? "아직 단어가 없어. 충전하기로 시작!" : `${chosen}/${state.today.length} 선택됨`;
  };

  const applyVisual = (rowEl, item) => {
    const thumb = rowEl.querySelector(".thumb");
    const leftZone = rowEl.querySelector(".zone.left");
    const rightZone = rowEl.querySelector(".zone.right");
    const center = rowEl.querySelector(".center");
    const stateEl = rowEl.querySelector("[data-state]");

    const x = clamp(item.x||0, -1, 1);
    const min=16, max=84;
    thumb.style.left = `${lerp(min,max,(x+1)/2)}%`;

    // thumb color
    if (x < -0.05){
      thumb.style.background = "var(--red)";
      thumb.style.color = "#fff";
    } else if (x > 0.05){
      thumb.style.background = "var(--green)";
      thumb.style.color = "#fff";
    } else {
      thumb.style.background = "rgba(0,0,0,.10)";
      thumb.style.color = "rgba(0,0,0,.86)";
    }

    const leftEm = clamp(-x,0,1), rightEm = clamp(x,0,1);
    leftZone.style.color = `rgba(0,0,0,${lerp(.30,.70,leftEm)})`;
    rightZone.style.color = `rgba(0,0,0,${lerp(.30,.70,rightEm)})`;

    stateEl.textContent = stateLabel(item.state);
    center.textContent = (item.state==="neutral") ? item.w : item.m;
    center.classList.toggle("meaning", item.state!=="neutral");
  };

  const finalSnap = (x) => {
    const TH = 0.28;
    if (x <= -TH) return "dont";
    if (x >= TH) return "know";
    return "neutral";
  };

  const render = () => {
    const rows = $("rows");
    rows.innerHTML = "";

    state.today.forEach((item, idx) => {
      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div class="track">
          <div class="zone left">몰라요</div>
          <div class="center">${escapeHtml(item.w)}</div>
          <div class="zone right">알아요</div>
          <div class="thumb">${escapeHtml(item.w)}</div>
        </div>
        <div class="meta">
          <div>상태: <span class="state" data-state>${stateLabel(item.state)}</span></div>
          <div style="opacity:.7">드래그/클릭 가능</div>
        </div>
      `;
      rows.appendChild(el);

      applyVisual(el, item);

      const thumb = el.querySelector(".thumb");
      const track = el.querySelector(".track");
      const leftZone = el.querySelector(".zone.left");
      const rightZone = el.querySelector(".zone.right");

      leftZone.addEventListener("click", () => {
        item.state="dont"; item.x=-1; saveState(state); applyVisual(el,item); updateTop();
      });
      rightZone.addEventListener("click", () => {
        item.state="know"; item.x=1; saveState(state); applyVisual(el,item); updateTop();
      });

      // Drag
      let dragging=false, startX=0, startPct=0;
      thumb.addEventListener("pointerdown", (e)=>{
        dragging=true;
        thumb.setPointerCapture(e.pointerId);
        startX = e.clientX;

        const rect = track.getBoundingClientRect();
        const curLeft = parseFloat(thumb.style.left || "50");
        startPct = curLeft/100;

        thumb.style.transition="none";
        e.preventDefault();
      });

      thumb.addEventListener("pointermove", (e)=>{
        if(!dragging) return;
        const rect = track.getBoundingClientRect();
        const dx = e.clientX - startX;
        const pct = clamp(startPct + dx/rect.width, 0, 1);
        item.x = (pct*2)-1; // -1..1
        applyVisual(el,item);
      });

      const endDrag = ()=>{
        if(!dragging) return;
        dragging=false;
        thumb.style.transition="";
        const snapped = finalSnap(clamp(item.x||0,-1,1));
        item.state = snapped;
        item.x = snapped==="dont"?-1:snapped==="know"?1:0;
        saveState(state);
        applyVisual(el,item);
        updateTop();
      };

      thumb.addEventListener("pointerup", endDrag);
      thumb.addEventListener("pointercancel", endDrag);
    });

    updateTop();
  };

  // Modals
  const openBD = (id)=>$(id).classList.add("show");
  const closeBD = (id)=>$(id).classList.remove("show");

  $("btnCharge").addEventListener("click", ()=>{
    state = loadState();
    const left = Math.max(0, dailyChargeLimit - (state.meta.chargeUsed||0));
    $("chargeTip").textContent = pickTipNoRepeatToday(state);
    $("chargeSub").textContent = `누를 때마다 오늘의 단어가 ${todayTargetAdd}개 추가돼. (프로토타입: 프리셋 풀에서 랜덤 채움)`;
    $("chargeRemain").textContent = `오늘 남은 충전 ${left}/${dailyChargeLimit}`;
    $("chargeDo").disabled = left<=0;
    openBD("chargeBD");
  });
  $("chargeClose").addEventListener("click", ()=>closeBD("chargeBD"));
  $("chargeBD").addEventListener("click", (e)=>{ if(e.target.id==="chargeBD") closeBD("chargeBD"); });

  $("chargeDo").addEventListener("click", async ()=>{
    state = loadState();
    const used = state.meta.chargeUsed||0;
    const left = dailyChargeLimit - used;
    if(left<=0){ toast("오늘 충전은 이미 3번 다 썼어."); return; }

    const added = addTodayWords(state, todayTargetAdd);
    state.meta.chargeUsed = used + 1;
    saveState(state);

    closeBD("chargeBD");
    toast(`오늘의 단어 ${added}개 충전 완료!`);
    render();
  });

  $("btnSubmit").addEventListener("click", ()=>{
    state = loadState();
    if(state.today.length===0){ toast("단어가 0개야. 먼저 충전하기!"); return; }
    const un = state.today.filter(x=>x.state==="neutral").length;
    if(un>0){ toast(`미선택 ${un}개가 있어. 전부 선택해야 제출 가능!`); return; }
    $("submitTip").textContent = pickTipNoRepeatToday(state);
    openBD("submitBD");
  });
  $("submitClose").addEventListener("click", ()=>closeBD("submitBD"));
  $("submitBD").addEventListener("click", (e)=>{ if(e.target.id==="submitBD") closeBD("submitBD"); });

  $("submitDo").addEventListener("click", async ()=>{
    closeBD("submitBD");
    state = loadState();

    const now = Date.now();
    let submitted = 0;

    state.today.forEach(item=>{
      const w=item.w;
      const ws = state.wordStats[w] || { latest:null, knowCount:0, dontCount:0, lastKnowAt:null, lastDontAt:null, lastAnyAt:null };
      if(item.state==="know"){
        ws.latest="know"; ws.knowCount++; ws.lastKnowAt=now; ws.lastAnyAt=now; submitted++;
      } else if(item.state==="dont"){
        ws.latest="dont"; ws.dontCount++; ws.lastDontAt=now; ws.lastAnyAt=now; submitted++;
      }
      state.wordStats[w]=ws;
    });

    state.processedSubmitCount = (state.processedSubmitCount||0) + submitted;
    saveState(state);

    openBD("overlayBD");
    await sleep(700);
    window.location.href = "hub.html";
  });

  // Boot
  render();
})();
</script>
</body>
</html>
